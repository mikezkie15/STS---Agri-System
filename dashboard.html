<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Barangay Agri-Market</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-seedling me-2"></i>Agri-Market
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="products.html">Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="requests.html">Requests</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="announcements.html">Announcements</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user me-1"></i>My Account
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="profile.html">Profile</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5">
    <div class="row">
      <div class="col-12">
        <h1 class="mb-4">Dashboard</h1>
        <p class="text-muted mb-4">Welcome back! Here's what's happening in your account.</p>

        <!-- User Type Specific Content -->
        <div id="userContent">
          <!-- Content will be loaded based on user type -->
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-light py-4 mt-5">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h5>Barangay Agri-Market</h5>
          <p>Connecting farmers and buyers in our community.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p>&copy; 2024 Barangay Agri-Market. All rights reserved.</p>
          <p>Contact: +63 XXX XXX XXXX</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    let currentUser = null;

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', function () {
      checkAuthAndLoadDashboard();
    });

    // Check authentication and load dashboard
    async function checkAuthAndLoadDashboard() {
      const token = localStorage.getItem('auth_token');
      const userData = localStorage.getItem('user_data');

      if (!token || !userData) {
        window.location.href = 'login.html';
        return;
      }

      try {
        currentUser = JSON.parse(userData);
        loadDashboardContent();
      } catch (error) {
        console.error('Error parsing user data:', error);
        window.location.href = 'login.html';
      }
    }

    // Load dashboard content based on user type
    function loadDashboardContent() {
      const container = document.getElementById('userContent');

      if (currentUser.user_type === 'farmer') {
        loadFarmerDashboard(container);
      } else if (currentUser.user_type === 'buyer') {
        loadBuyerDashboard(container);
      } else if (currentUser.user_type === 'admin') {
        loadAdminDashboard(container);
      }
    }

    // Load farmer dashboard
    function loadFarmerDashboard(container) {
      container.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-seedling me-2"></i>My Products</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <p class="mb-0">Manage your product listings</p>
                                    <button class="btn btn-success" onclick="addProduct()">
                                        <i class="fas fa-plus me-1"></i>Add Product
                                    </button>
                                </div>
                                <div id="myProducts">
                                    <!-- Products will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Recent Messages</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">No messages yet. When buyers contact you about your products, they'll appear here.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quick Stats</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 class="text-success" id="totalProducts">0</h4>
                                        <small class="text-muted">Products Listed</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-info" id="activeProducts">0</h4>
                                        <small class="text-muted">Active Products</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Recent Announcements</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentAnnouncements">
                                    <!-- Announcements will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

      loadFarmerData();
    }

    // Load buyer dashboard
    function loadBuyerDashboard(container) {
      container.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>My Requests</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <p class="mb-0">Post what you need and get contacted by sellers</p>
                                    <button class="btn btn-success" onclick="addRequest()">
                                        <i class="fas fa-plus me-1"></i>Post Request
                                    </button>
                                </div>
                                <div id="myRequests">
                                    <!-- Requests will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Recommended Products</h5>
                            </div>
                            <div class="card-body">
                                <div id="recommendedProducts">
                                    <!-- Recommended products will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quick Stats</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 class="text-success" id="totalRequests">0</h4>
                                        <small class="text-muted">Requests Posted</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-info" id="activeRequests">0</h4>
                                        <small class="text-muted">Active Requests</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Recent Announcements</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentAnnouncements">
                                    <!-- Announcements will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

      loadBuyerData();
    }

    // Load admin dashboard
    function loadAdminDashboard(container) {
      container.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Admin Panel</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-success w-100" onclick="manageUsers()">
                                            <i class="fas fa-users me-2"></i>Manage Users
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-success w-100" onclick="manageAnnouncements()">
                                            <i class="fas fa-bullhorn me-2"></i>Manage Announcements
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-success w-100" onclick="verifySellers()">
                                            <i class="fas fa-check-circle me-2"></i>Verify Sellers
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-success w-100" onclick="viewReports()">
                                            <i class="fas fa-chart-line me-2"></i>View Reports
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>System Stats</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 class="text-success" id="totalUsers">0</h4>
                                        <small class="text-muted">Total Users</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-info" id="totalProducts">0</h4>
                                        <small class="text-muted">Total Products</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

      loadAdminData();
    }

    // Load farmer data
    async function loadFarmerData() {
      // Load farmer's products
      try {
        const response = await fetch(`api/products.php?seller_id=${currentUser.id}`);
        const data = await response.json();

        if (data.success) {
          const products = data.data.products;
          displayMyProducts(products);
          updateFarmerStats(products);
        }
      } catch (error) {
        console.error('Error loading farmer data:', error);
      }

      // Load recent announcements
      loadRecentAnnouncements();
    }

    // Load buyer data
    async function loadBuyerData() {
      // Load buyer's requests
      try {
        const response = await fetch(`api/requests.php?buyer_id=${currentUser.id}`);
        const data = await response.json();

        if (data.success) {
          const requests = data.data.requests;
          displayMyRequests(requests);
          updateBuyerStats(requests);
        }
      } catch (error) {
        console.error('Error loading buyer data:', error);
      }

      // Load recommended products
      loadRecommendedProducts();

      // Load recent announcements
      loadRecentAnnouncements();
    }

    // Display buyer's requests
    function displayMyRequests(requests) {
      const container = document.getElementById('myRequests');

      if (requests.length === 0) {
        container.innerHTML = '<p class="text-muted">No requests posted yet. <a href="#" onclick="addRequest()">Post your first request</a></p>';
        return;
      }

      container.innerHTML = requests.map(request => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1">${request.product_name}</h6>
                        <p class="text-muted mb-1">${request.quantity} ${request.unit}</p>
                        <small class="text-success">Status: ${request.status}</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editRequest(${request.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRequest(${request.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
      `).join('');
    }

    // Update buyer stats
    function updateBuyerStats(requests) {
      const totalRequests = requests.length;
      const activeRequests = requests.filter(r => r.status === 'active').length;

      document.getElementById('totalRequests').textContent = totalRequests;
      document.getElementById('activeRequests').textContent = activeRequests;
    }

    // Load recommended products
    function loadRecommendedProducts() {
      const container = document.getElementById('recommendedProducts');
      container.innerHTML = '<p class="text-muted">No recommended products at the moment.</p>';
    }

    // Load admin data
    async function loadAdminData() {
      // Load system stats
      try {
        const response = await fetch('api/admin/stats.php');
        const data = await response.json();

        if (data.success) {
          updateAdminStats(data.data);
        }
      } catch (error) {
        console.error('Error loading admin data:', error);
      }
    }

    // Display farmer's products
    function displayMyProducts(products) {
      const container = document.getElementById('myProducts');

      if (products.length === 0) {
        container.innerHTML = '<p class="text-muted">No products listed yet. <a href="#" onclick="addProduct()">Add your first product</a></p>';
        return;
      }

      container.innerHTML = products.map(product => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${product.name}</h6>
                                <p class="text-muted mb-1">${product.description || 'No description'}</p>
                                <small class="text-success">â‚±${parseFloat(product.price).toFixed(2)} per ${product.unit}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${product.is_available ? 'bg-success' : 'bg-secondary'} mb-2">
                                    ${product.is_available ? 'Available' : 'Unavailable'}
                                </span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    // Update farmer stats
    function updateFarmerStats(products) {
      const totalProducts = products.length;
      const activeProducts = products.filter(p => p.is_available).length;

      document.getElementById('totalProducts').textContent = totalProducts;
      document.getElementById('activeProducts').textContent = activeProducts;
    }

    // Load recent announcements
    async function loadRecentAnnouncements() {
      try {
        const response = await fetch('api/announcements.php?limit=3');
        const data = await response.json();

        if (data.success) {
          const announcements = data.data.announcements;
          displayRecentAnnouncements(announcements);
        }
      } catch (error) {
        console.error('Error loading announcements:', error);
      }
    }

    // Display recent announcements
    function displayRecentAnnouncements(announcements) {
      const container = document.getElementById('recentAnnouncements');

      if (announcements.length === 0) {
        container.innerHTML = '<p class="text-muted">No announcements available</p>';
        return;
      }

      container.innerHTML = announcements.map(announcement => `
                <div class="mb-3">
                    <h6 class="mb-1">${announcement.title}</h6>
                    <p class="text-muted small mb-1">${announcement.content.substring(0, 100)}${announcement.content.length > 100 ? '...' : ''}</p>
                    <small class="text-muted">${formatDate(announcement.created_at)}</small>
                </div>
            `).join('');
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Action functions
    function addProduct() {
      window.location.href = 'add-product.html';
    }

    function addRequest() {
      window.location.href = 'add-request.html';
    }

    function editProduct(productId) {
      window.location.href = `edit-product.html?id=${productId}`;
    }

    function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        // Implement delete functionality
        console.log('Delete product:', productId);
      }
    }

    function logout() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_data');
      window.location.href = 'index.html';
    }
  </script>
</body>

</html>