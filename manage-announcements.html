<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Announcements - Barangay Agri-Market</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-seedling me-2"></i>Agri-Market Admin
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="admin-dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="manage-users.html">Manage Users</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="manage-announcements.html">Manage Announcements</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user-shield me-1"></i>Admin
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="admin-dashboard.html">Dashboard</a></li>
              <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="mb-0">Manage Announcements</h1>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
            <i class="fas fa-plus me-2"></i>Create Announcement
          </button>
        </div>
        <p class="text-muted mb-4">Create, edit, and delete announcements.</p>

        <div id="announcementsTableContainer">
          <!-- Announcements table will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Create Announcement Modal -->
  <div class="modal fade" id="createAnnouncementModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Announcement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createAnnouncementForm">
            <div class="mb-3">
              <label for="createAnnouncementTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="createAnnouncementTitle" required>
            </div>
            <div class="mb-3">
              <label for="createAnnouncementContent" class="form-label">Content</label>
              <textarea class="form-control" id="createAnnouncementContent" rows="3" required></textarea>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="createIsImportant">
              <label class="form-check-label" for="createIsImportant">
                Mark as Important
              </label>
            </div>
            <button type="submit" class="btn btn-primary">Create Announcement</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Announcement Modal -->
  <div class="modal fade" id="editAnnouncementModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Announcement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editAnnouncementForm">
            <input type="hidden" id="editAnnouncementId">
            <div class="mb-3">
              <label for="editAnnouncementTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="editAnnouncementTitle" required>
            </div>
            <div class="mb-3">
              <label for="editAnnouncementContent" class="form-label">Content</label>
              <textarea class="form-control" id="editAnnouncementContent" rows="3" required></textarea>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="editIsImportant">
              <label class="form-check-label" for="editIsImportant">
                Mark as Important
              </label>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-light py-4 mt-5">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h5>Barangay Agri-Market</h5>
          <p>Connecting farmers and buyers in our community.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p>&copy; 2024 Barangay Agri-Market. All rights reserved.</p>
          <p>Contact: +63 XXX XXX XXXX</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      checkAdminAuth();
      loadAnnouncements();

      document.getElementById('createAnnouncementForm').addEventListener('submit', handleCreateAnnouncement);
      document.getElementById('editAnnouncementForm').addEventListener('submit', handleEditAnnouncement);
    });

    function checkAdminAuth() {
      const token = localStorage.getItem('auth_token');
      const userData = localStorage.getItem('user_data');

      if (!token || !userData) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const user = JSON.parse(userData);
        if (user.user_type !== 'admin') {
          alert('Access denied. Admin privileges required.');
          window.location.href = 'dashboard.html';
        }
      } catch (error) {
        console.error('Error parsing user data:', error);
        window.location.href = 'login.html';
      }
    }

    async function loadAnnouncements() {
      const container = document.getElementById('announcementsTableContainer');

      try {
        const response = await fetch('api/announcements.php');
        const result = await response.json();

        if (result.success) {
          renderAnnouncementsTable(result.data.announcements);
        } else {
          container.innerHTML = '<p class="text-muted">Failed to load announcements.</p>';
        }
      } catch (error) {
        console.error('Error loading announcements:', error);
        container.innerHTML = '<p class="text-muted">Unable to load announcements.</p>';
      }
    }

    function renderAnnouncementsTable(announcements) {
      const container = document.getElementById('announcementsTableContainer');
      let tableHtml = '<table class="table table-striped"><thead><tr><th>Title</th><th>Content</th><th>Important</th><th>Created At</th><th>Actions</th></tr></thead><tbody>';

      if (announcements.length === 0) {
        tableHtml += '<tr><td colspan="5" class="text-center">No announcements found.</td></tr>';
      } else {
        announcements.forEach(announcement => {
          tableHtml += `
            <tr>
              <td>${announcement.title}</td>
              <td>${announcement.content}</td>
              <td>${announcement.is_important ? '<i class="fas fa-check text-success"></i>' : ''}</td>
              <td>${new Date(announcement.created_at).toLocaleString()}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="openEditAnnouncementModal(${announcement.id}, '${announcement.title}', '${announcement.content}', ${announcement.is_important})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="handleDeleteAnnouncement(${announcement.id})"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        });
      }

      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
    }
    async function handleCreateAnnouncement(event) {
      event.preventDefault();

      const title = document.getElementById('createAnnouncementTitle').value;
      const content = document.getElementById('createAnnouncementContent').value;
      const is_important = document.getElementById('createIsImportant').checked;

      const response = await fetch('api/announcements.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
        },
        body: JSON.stringify({ title, content, is_important, token: localStorage.getItem('auth_token') })
      });

      const result = await response.json();

      if (result.success) {
        alert('Announcement created successfully');
        const modal = bootstrap.Modal.getInstance(document.getElementById('createAnnouncementModal'));
        modal.hide();
        loadAnnouncements(); // Refresh table
        document.getElementById('createAnnouncementForm').reset();
      } else {
        alert('Error creating announcement: ' + result.message);
      }
    }
    function openEditAnnouncementModal(id, title, content, is_important) {
      document.getElementById('editAnnouncementId').value = id;
      document.getElementById('editAnnouncementTitle').value = title;
      document.getElementById('editAnnouncementContent').value = content;
      document.getElementById('editIsImportant').checked = is_important;

      const modal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
      modal.show();
    }

    async function handleEditAnnouncement(event) {
      event.preventDefault();

      const id = document.getElementById('editAnnouncementId').value;
      const title = document.getElementById('editAnnouncementTitle').value;
      const content = document.getElementById('editAnnouncementContent').value;
      const is_important = document.getElementById('editIsImportant').checked;

      const response = await fetch('api/announcements.php', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
        },
        body: JSON.stringify({ id, title, content, is_important, token: localStorage.getItem('auth_token') })
      });

      const result = await response.json();

      if (result.success) {
        alert('Announcement updated successfully');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editAnnouncementModal'));
        modal.hide();
        loadAnnouncements(); // Refresh table
      } else {
        alert('Error updating announcement: ' + result.message);
      }
    }

    async function handleDeleteAnnouncement(id) {
      if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
      }

      const response = await fetch(`api/announcements.php?id=${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
        },
        body: JSON.stringify({ token: localStorage.getItem('auth_token') })
      });

      const result = await response.json();

      if (result.success) {
        alert('Announcement deleted successfully');
        loadAnnouncements(); // Refresh table
      } else {
        alert('Error deleting announcement: ' + result.message);
      }
    }

    function logout() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_data');
      window.location.href = 'index.html';
    }
  </script>
</body>

</html>