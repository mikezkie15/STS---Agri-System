<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post a Request - Barangay Agri-Market</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-seedling me-2"></i>Agri-Market
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="products.html">Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="requests.html">Requests</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="announcements.html">Announcements</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Post a New Request</h4>
          </div>
          <div class="card-body">
            <form id="addRequestForm">
              <div class="mb-3">
                <label for="requestTitle" class="form-label">Request Title *</label>
                <input type="text" class="form-control" id="requestTitle" name="title" required placeholder="e.g., Fresh tomatoes needed">
              </div>

              <div class="mb-3">
                <label for="requestDescription" class="form-label">Description *</label>
                <textarea class="form-control" id="requestDescription" name="description" rows="3" required placeholder="Describe the product you are looking for..."></textarea>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="requestQuantity" class="form-label">Quantity</label>
                  <input type="number" class="form-control" id="requestQuantity" name="quantity" step="0.01" min="0">
                </div>

                <div class="col-md-4 mb-3">
                  <label for="requestUnit" class="form-label">Unit</label>
                  <select class="form-select" id="requestUnit" name="unit">
                    <option value="">Select unit</option>
                    <option value="kg">Kilogram (kg)</option>
                    <option value="g">Gram (g)</option>
                    <option value="lbs">Pound (lbs)</option>
                    <option value="piece">Piece</option>
                    <option value="bunch">Bunch</option>
                    <option value="dozen">Dozen</option>
                    <option value="box">Box</option>
                    <option value="sack">Sack</option>
                  </select>
                </div>
                
                <div class="col-md-4 mb-3">
                  <label for="requestMaxPrice" class="form-label">Max Price (â‚±)</label>
                  <input type="number" class="form-control" id="requestMaxPrice" name="max_price" step="0.01" min="0" placeholder="Optional">
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="dashboard.html" class="btn btn-secondary me-md-2">Cancel</a>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-paper-plane me-1"></i>Post Request
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-light py-4 mt-5">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h5>Barangay Agri-Market</h5>
          <p>Connecting farmers and buyers in our community.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p>&copy; 2024 Barangay Agri-Market. All rights reserved.</p>
          <p>Contact: +63 XXX XXX XXXX</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    let currentUser = null;

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function () {
      checkAuthAndLoadPage();
    });

    // Check authentication and load page
    async function checkAuthAndLoadPage() {
      const token = localStorage.getItem('auth_token');
      const userData = localStorage.getItem('user_data');

      if (!token || !userData) {
        alert('Please login to post a request');
        window.location.href = 'login.html';
        return;
      }

      try {
        currentUser = JSON.parse(userData);
        // Validate token with server
        const response = await fetch('api/auth.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action: 'validate', token: token })
        });

        const data = await response.json();
        if (data.success) {
          currentUser = data.user;
          if (currentUser.user_type !== 'buyer') {
            alert('Only buyers can post requests.');
            window.location.href = 'dashboard.html';
          }
          updateNavigation();
        } else {
          // Token is invalid, redirect to login
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_data');
          alert('Session expired. Please login again.');
          window.location.href = 'login.html';
        }
      } catch (error) {
        console.error('Error validating token:', error);
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_data');
        alert('Session expired. Please login again.');
        window.location.href = 'login.html';
      }
    }

    // Update navigation based on user status
    function updateNavigation() {
      const nav = document.querySelector("#navbarNav ul");
      if (!nav || !currentUser) return;

      // Remove login link and add user-specific links
      const loginLink = nav.querySelector('a[href="login.html"]');
      if (loginLink) {
        loginLink.parentElement.remove();
      }

      // Add user menu
      const userMenu = document.createElement("li");
      userMenu.className = "nav-item dropdown";
      userMenu.innerHTML = `
        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
          <i class="fas fa-user me-1"></i>${currentUser.name}
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="dashboard.html">Dashboard</a></li>
          <li><a class="dropdown-item" href="profile.html">Profile</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
        </ul>
      `;
      nav.appendChild(userMenu);
    }

    // Logout function
    function logout() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_data');
      currentUser = null;
      window.location.href = 'index.html';
    }

    // Handle add request form submission
    document.getElementById('addRequestForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Check if user is logged in
      const token = localStorage.getItem('auth_token');
      if (!token) {
        alert('Please login to post a request');
        window.location.href = 'login.html';
        return;
      }

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      // Remove empty fields
      Object.keys(data).forEach(key => {
        if (data[key] === '') {
          delete data[key];
        }
      });

      try {
        const response = await fetch('api/requests.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          showSuccess('Request posted successfully!', document.querySelector('.card-body'));

          // Redirect to dashboard after 2 seconds
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2000);
        } else {
          showError(result.message, document.querySelector('.card-body'));
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Network error. Please check your connection and try again.', document.querySelector('.card-body'));
      }
    });
  </script>
</body>

</html>
